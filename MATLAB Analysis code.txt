% ðŸ“Œ CONFIGURACIÃ“N DEL CANAL
canalID = 2851829; % ID del canal en ThingSpeak donde se almacenarÃ¡n los datos
apiKeyLectura = 'YMZ6Y18IF7T1QPC6'; % API Key utilizada para leer datos del canal
apiKeyEscritura = '639WYS3QCL49XPO0'; % API Key utilizada para escribir datos en el canal
fieldNumLM35 = 1; % NÃºmero del Field en ThingSpeak donde se almacena la temperatura del sensor LM35
fieldNumPromedio = 3; % NÃºmero del Field en ThingSpeak donde se almacenarÃ¡ el promedio de temperatura
numDatosRequeridos = 10; % NÃºmero de datos necesarios para calcular el promedio de temperatura

% ðŸ“Œ LEER LOS DATOS ALMACENADOS
% Lee los Ãºltimos 'numDatosRequeridos' valores del Field 3 en ThingSpeak, donde se guarda el promedio
% Esto es Ãºtil para mantener un historial de datos recientes
datosPrevios = thingSpeakRead(canalID, 'Fields', fieldNumPromedio, 'NumPoints', numDatosRequeridos, 'ReadKey', apiKeyLectura);

% ðŸ“Œ OBTENER EL NUEVO DATO DEL SENSOR LM35
% Lee el Ãºltimo dato almacenado en Field 1 (temperatura del sensor LM35)
nuevoDato = thingSpeakRead(canalID, 'Fields', fieldNumLM35, 'NumPoints', 1, 'ReadKey', apiKeyLectura);

% ðŸ“Œ VERIFICAR SI SE OBTUVO UN NUEVO DATO
% Si no se obtiene un nuevo dato o el valor es NaN, muestra un mensaje y detiene la ejecuciÃ³n
if isempty(nuevoDato) || isnan(nuevoDato)
    disp('âš ï¸ No se obtuvo un nuevo dato. Esperando mÃ¡s mediciones.');
    return;
end

% ðŸ“Œ AGREGAR EL NUEVO DATO AL HISTORIAL
if isempty(datosPrevios)  % Si no hay datos previos almacenados, inicializa la lista con el nuevo dato
    datosPrevios = nuevoDato;
else
    datosPrevios = [datosPrevios; nuevoDato]; % Agregar el nuevo dato a la lista de datos previos
end

% ðŸ“Œ ASEGURAR QUE SOLO SE GUARDEN LOS ÃšLTIMOS 10 DATOS
% Si la lista de datos tiene mÃ¡s de 'numDatosRequeridos', elimina el dato mÃ¡s antiguo
if length(datosPrevios) > numDatosRequeridos
    datosPrevios(1) = []; % Eliminar el primer dato de la lista para mantener solo los Ãºltimos 10
end

% ðŸ“Œ VERIFICAR SI YA TENEMOS 10 DATOS
% Si aÃºn no hay suficientes datos, muestra un mensaje y detiene la ejecuciÃ³n
if length(datosPrevios) < numDatosRequeridos
    disp('â³ AÃºn no hay suficientes datos para calcular el promedio. Esperando mÃ¡s mediciones.');
    return;
end

% ðŸ“Œ CALCULAR EL PROMEDIO
% Calcula el promedio de los Ãºltimos 10 valores obtenidos, ignorando posibles valores NaN
promedioTemperatura = mean(datosPrevios, 'omitnan');

% ðŸ“Œ MOSTRAR PROMEDIO EN CONSOLA
% Muestra el valor del promedio en la consola para depuraciÃ³n
fprintf('ðŸŒ¡ï¸ Promedio de los Ãºltimos 10 datos: %.2fÂ°C\n', promedioTemperatura);

% ðŸ“Œ GUARDAR EL PROMEDIO EN FIELD 3 DE THINGSPEAK
% Escribe el valor del promedio en Field 3 en ThingSpeak para su almacenamiento y visualizaciÃ³n
thingSpeakWrite(canalID, 'Fields', fieldNumPromedio, 'Values', promedioTemperatura, 'WriteKey', apiKeyEscritura);
disp('âœ… Promedio guardado en ThingSpeak.');

% ðŸ“Œ SI EL PROMEDIO SUPERA LOS 50Â°C, ENVIAR ALERTA POR EMAIL
% Si la temperatura promedio supera los 50Â°C, genera una alerta y envÃ­a un mensaje
if promedioTemperatura > 50
    alertMessage = sprintf('ðŸš¨ ALERTA: La temperatura promedio es %.2fÂ°C y supera los 50Â°C.', promedioTemperatura);
    disp(alertMessage);
    
    % ðŸ“Œ ENVIAR ALERTA A THINGSPEAK ALERTS
    % Llama a la funciÃ³n de alertas de ThingSpeak para enviar un correo de notificaciÃ³n
    thingSpeakAlert('Alerta Temperatura Alta', alertMessage);
end
